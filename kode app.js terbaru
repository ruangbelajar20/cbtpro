// ============================================================================
// 1. KONFIGURASI & STATE (PUSAT PENYIMPANAN)
// ============================================================================

const CONFIG = {
    // API Key & URL Supabase
    SUPABASE_URL: 'https://vgemkulcjnpjquabhguv.supabase.co',
    SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnZW1rdWxjam5wanF1YWJoZ3V2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MzUwNTEsImV4cCI6MjA4MDQxMTA1MX0.Z0NxOpNZAhuNlFuR_2h0uRLD8x4gYNpEI9veHNCxKxQ',
    
    // Ticker Text
    TICKER_MESSAGES: [
        { text: '<span class="text-yellow-400 font-bold mr-2">[INFO UJIAN]</span> Selamat Datang di Portal Ujian CBT Pro.', anim: 'anim-scroll', duration: 20000 },
        { text: '<span class="text-blue-400 font-bold mr-2">[BANTUAN]</span> Jika terkendala hubungi Admin.', anim: 'anim-center-expand', duration: 10000 }
    ]
};

// Inisialisasi Supabase
const db = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);

// State Management Global
const STATE = {
    editing: {
        classId: null,
        roomId: null,
        examId: null,
        pendingDeleteId: null,
        pendingDeleteType: null
    },
    ui: {
        tickerIndex: 0,
        cardLogo: "https://via.placeholder.com/50",
        cardSignature: "",
        selectedStudentIds: []
    },
    cache: {
        students: [],
        classes: [],
        rooms: [],
        questions: [],
        exams: [],
        recap: []
    },
    intervals: {
        tokenTimer: null
    },
    realtime: {
        presenceChannel: null 
    }
};

// ============================================================================
// 2. UTILITIES (ALAT BANTU & KEAMANAN)
// ============================================================================
const Utils = {
    // [SECURITY] Sanitasi XSS (Wajib ada!)
    escapeHTML(str) {
        if (!str) return '';
        return String(str).replace(/[&<>'"]/g, tag => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
        }[tag]));
    },

    getEl(id) { return document.getElementById(id); },

    setLoading(btn, isLoading, text = 'Loading...') {
        if (!btn) return;
        if (isLoading) {
            btn.dataset.originalText = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin">⏳</span> ${text}`;
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
        } else {
            btn.innerHTML = btn.dataset.originalText || 'Simpan';
            btn.disabled = false;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }
    },

    formatDate(dateString) {
        if (!dateString) return '-';
        return new Date(dateString).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
    }
};

// ============================================================================
// 3. SERVICE LAYER (DATABASE)
// ============================================================================
const DB = {
    // --- DATA SISWA ---
    async getStudents() {
        const { data, error } = await db.from('students').select('*').order('created_at', { ascending: false });
        if (error) return [];
        return data;
    },

    // --- DATA UTAMA (KELAS, RUANG, UJIAN) ---
    async getClasses() {
        const { data } = await db.from('classes').select('*');
        return (data || []).map(c => ({ id: c.id, code: c.kode_kelas, name: c.nama_kelas, desc: c.deskripsi, count: 0, date: 'Terdaftar' }));
    },
    async getRooms() {
        const { data } = await db.from('rooms').select('*');
        return (data || []).map(r => ({ id: r.id, code: r.kode_ruangan, name: r.nama_ruangan, desc: r.deskripsi, count: 0, date: 'Terdaftar' }));
    },
    async getExams() {
        const { data } = await db.from('exams').select('*').order('created_at', { ascending: false });
        return (data || []).map(e => ({
            id: e.id, name: e.nama_ujian, status: e.status, alokasi: e.alokasi,
            peserta: e.peserta || 0, pengelola: e.pengelola || 'Admin'
        }));
    },
    async getQuestions() {
        const { data } = await db.from('questions').select('*').order('created_at', { ascending: false });
        return data || [];
    },

    // --- LIST UNTUK DROPDOWN ---
    async getClassList() {
        const { data } = await db.from('classes').select('nama_kelas').order('nama_kelas');
        return (data || []).map(i => i.nama_kelas);
    },
    async getRoomList() {
        const { data } = await db.from('rooms').select('nama_ruangan').order('nama_ruangan');
        return (data || []).map(i => i.nama_ruangan);
    },
    async getExamList() {
        const { data } = await db.from('exams').select('id, nama_ujian').eq('status', 'Aktif');
        return data || [];
    },

    // --- FUNGSI TOKEN & PENGATURAN ---
    async updateToken(tokenCode) {
        // Update Token Code saja
        const { error } = await db.from('exam_settings').update({ 
            token_code: tokenCode, 
            updated_at: new Date() 
        }).eq('id', 1);
        return { error };
    },
    async updateTokenConfig(duration, autoRefresh) {
        // Update Durasi & Status Auto Refresh
        const { error } = await db.from('exam_settings').update({ 
            token_duration: duration,
            auto_refresh: autoRefresh,
            updated_at: new Date() 
        }).eq('id', 1);
        return { error };
    },
    async getTokenSettings() {
        const { data } = await db.from('exam_settings').select('*').eq('id', 1).single();
        return data;
    },

    // --- BULK ACTIONS (EKSEKUSI MASSAL) ---
    async bulkUpdateStudents(filterCol, filterValues, updateData) {
        const { error } = await db.from('students').update(updateData).in(filterCol, filterValues);
        return { error };
    },
    async bulkDeleteStudents(ids) {
        const { error } = await db.from('students').delete().in('id_peserta', ids);
        return { error };
    },
    async registerExamParticipants(examId, studentIds) {
        const records = studentIds.map(sid => ({ exam_id: examId, student_id: sid, status: 'Terdaftar', created_at: new Date() }));
        const { error } = await db.from('exam_participants').insert(records);
        return { error };
    },

    // --- HELPERS ---
    async getCount(table) { const { count } = await db.from(table).select('*', { count: 'exact', head: true }); return count || 0; },
    async getCountByFilter(table, col, val) { const { count } = await db.from(table).select('*', { count: 'exact', head: true }).eq(col, val); return count || 0; },
    async getStudentOnline() { return this.getCountByFilter('students', 'status_login', true); },
    async getUserTotalByRole(role) { return this.getCountByFilter('users', 'role', role); },
    async getUserOnline(role) { const { count } = await db.from('users').select('*', { count: 'exact', head: true }).eq('role', role).eq('status_login', true); return count || 0; },
    async getActiveExams() { return this.getCountByFilter('exams', 'status', 'Aktif'); },
    async getSiteStats() { const { data } = await db.from('site_stats').select('total_hits').maybeSingle(); return data ? data.total_hits : 0; },
    
    // CRUD Create/Update/Delete lainnya tetap sama...
    async addStudent(d) { return await db.from('students').insert([d]); },
    async addClass(d) { return await db.from('classes').insert([d]); },
    async updateClass(id, d) { return await db.from('classes').update(d).eq('id', id); },
    async deleteClass(id) { return await db.from('classes').delete().eq('id', id); },
    async addRoom(d) { return await db.from('rooms').insert([d]); },
    async updateRoom(id, d) { return await db.from('rooms').update(d).eq('id', id); },
    async deleteRoom(id) { return await db.from('rooms').delete().eq('id', id); },
    async addExam(d) { return await db.from('exams').insert([d]); },
    async updateExam(id, d) { return await db.from('exams').update(d).eq('id', id); },
    async deleteExam(id) { return await db.from('exams').delete().eq('id', id); },
    async addQuestion(d) { return await db.from('questions').insert([d]); },
    
    async incrementHit() { await db.rpc('increment_hit'); },
    async logDevice() { /* Kode logDevice tetap sama */ },
    async getDeviceLogs() { const { data } = await db.from('device_logs').select('*').order('last_seen', { ascending: false }).limit(50); return data || []; }
};

// ============================================================================
// 4. AUTHENTICATION (LOGIN/LOGOUT)
// ============================================================================
const Auth = {
    init() {
        const sessionRaw = localStorage.getItem('cbt_user_session');
        if (sessionRaw) {
            const session = JSON.parse(sessionRaw);
            this.setSessionUI();
            db.from('users').update({ status_login: true }).eq('id', session.id);
        }
    },

    async login(userIdID, passID, btnID) {
        const userInput = Utils.getEl(userIdID);
        const passInput = Utils.getEl(passID);
        const btn = Utils.getEl(btnID);

        const userVal = userInput ? userInput.value.trim() : '';
        const passVal = passInput ? passInput.value.trim() : '';

        if (!userVal || !passVal) {
            View.modals.showError("Data Tidak Lengkap", "Harap isi Username dan Password!");
            return;
        }

        Utils.setLoading(btn, true, "Checking...");

        try {
            const { data, error } = await db
                .from('users').select('id, username, role')
                .eq('username', userVal).eq('password', passVal)
                .single();

            if (error || !data) throw new Error("Username/Password Salah");

            const session = { id: data.id, username: data.username, role: data.role };
            localStorage.setItem('cbt_user_session', JSON.stringify(session));
            
            db.from('users').update({ status_login: true }).eq('id', data.id).then();

            const pinModal = Utils.getEl('modal-pin');
            if(pinModal) pinModal.classList.add('hidden');

            View.modals.showSuccess("Berhasil masuk!");

            if (window.supabase) {
                RealtimeFeatures.initPresence(); 
                View.updateDashboard(); 
            }

            setTimeout(() => {
                View.modals.closeSuccess();
                this.setSessionUI(); 
            }, 800); 

        } catch (err) {
            View.modals.showError("Gagal Masuk", "Username atau Password salah.");
            Utils.setLoading(btn, false, "Masuk");
        } finally {
            if (!localStorage.getItem('cbt_user_session')) {
                Utils.setLoading(btn, false, "Masuk");
            }
            if(passInput) passInput.value = '';
        }
    },

    logout() {
        const session = JSON.parse(localStorage.getItem('cbt_user_session'));
        if (session) {
            db.from('users').update({ status_login: false }).eq('id', session.id).then(() => {
                localStorage.removeItem('cbt_user_session');
                location.reload();
            });
        } else {
            location.reload();
        }
    },

    setSessionUI() {
        const viewLogin = Utils.getEl('view-login');
        const viewAdmin = Utils.getEl('view-admin');
        
        if(viewLogin) {
            viewLogin.style.opacity = '0';
            setTimeout(() => {
                viewLogin.classList.add('hidden-view');
                if(viewAdmin) {
                    viewAdmin.classList.remove('hidden-view');
                    setTimeout(() => viewAdmin.style.opacity = '1', 50);
                }
                View.nav('dashboard');
            }, 300); 
        } else {
            if(viewAdmin) viewAdmin.classList.remove('hidden-view');
            View.nav('dashboard');
        }
    }
};

// ============================================================================
// 5. VIEW CONTROLLER (LOGIKA TAMPILAN) - FULL UPDATE
// ============================================================================
const View = {
    // 1. Variabel State Seleksi
    selectedItems: [],

    // 2. Navigasi Utama
    nav(panelId) {
        // 1. Sembunyikan semua panel
        document.querySelectorAll('.admin-panel').forEach(p => p.classList.add('hidden-view'));
        
        // 2. Tampilkan panel yang dituju
        const target = Utils.getEl('panel-' + panelId) || Utils.getEl(panelId);
        if (target) {
            target.classList.remove('hidden-view');
            // Efek Fade In
            target.style.opacity = 0;
            setTimeout(() => target.style.opacity = 1, 50);
        }

        // 3. Update Sidebar Active State
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active-nav'));
        const activeBtn = Utils.getEl('nav-' + panelId);
        if (activeBtn) activeBtn.classList.add('active-nav');

        // 4. Tutup Sidebar di Mobile (Jika layar kecil)
        if (window.innerWidth < 768) {
            Utils.getEl('sidebar')?.classList.add('-translate-x-full');
            Utils.getEl('sidebar-overlay')?.classList.add('hidden');
        }

        // --- LOGIKA PER HALAMAN (HANYA TULIS SATU KALI) ---

        // A. Dashboard
        if (panelId === 'dashboard') this.updateDashboard();
        
        // B. Data Peserta
        if (panelId === 'students') {
            this.populateFilters(); // Isi filter Kelas/Ruangan di atas tabel
            this.renderStudents(false);
        }
        
        // C. Kelas & Ruangan
        if (panelId === 'classes') this.renderClasses();
        if (panelId === 'rooms') this.renderRooms();
        
        // D. Riwayat Koneksi
        if (panelId === 'connections') this.renderConnections();

        // E. Bank Soal (PENTING: Agar tidak blank)
        if (panelId === 'questions') {
            this.switchBankTab('soal'); // Buka tab daftar soal
            this.renderQuestions();
        }

        // F. Pengaturan (PENTING: Agar tidak blank)
        if (panelId === 'settings') {
            this.loadSettingsData(); // Ambil data token
            this.switchSettingTab(null, 'profile'); // Buka tab profil
        }

        // 5. Reset Seleksi (Agar tombol 'Terseleksi' kembali ke 0 saat pindah menu)
        this.selectedItems = [];
        this.updateBulkButtonUI();
    },

    toggleSidebar() {
        const sidebar = Utils.getEl('sidebar');
        const overlay = Utils.getEl('sidebar-overlay');
        if (sidebar && overlay) {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }
    },

    // --- LOGIKA SELEKSI & TOMBOL ---
    toggleSelect(id, isChecked) {
        if (isChecked) {
            this.selectedItems.push(id);
        } else {
            this.selectedItems = this.selectedItems.filter(item => item !== id);
        }
        this.updateBulkButtonUI(); 
    },

    toggleSelectAll(source, dataCache, keyName = 'name') {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        
        if (source.checked) {
            this.selectedItems = dataCache.map(item => item[keyName]); 
        } else {
            this.selectedItems = [];
        }
        this.updateBulkButtonUI(); 
    },

    updateBulkButtonUI() {
        const countSpan = document.getElementById('selection-count');
        const btnContainer = document.getElementById('dropdown-bulk-actions');
        
        if (countSpan) {
            countSpan.innerText = `(${this.selectedItems.length}) Terseleksi`;
        }
        if (this.selectedItems.length === 0 && btnContainer) {
            btnContainer.classList.add('hidden');
            btnContainer.classList.remove('block'); 
        }
    },

    // --- FUNGSI DATA (POPULATE) ---
    async populateFilters() {
        const filterClass = document.getElementById('filter-class');
        const filterRoom = document.getElementById('filter-room');

        if (filterClass && filterRoom) {
            const classes = await DB.getClassList();
            const rooms = await DB.getRoomList();

            filterClass.innerHTML = `<option value="Semua">Semua Kelas</option>` + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');

            filterRoom.innerHTML = `<option value="Semua">Semua Ruangan</option>` + 
                rooms.map(r => `<option value="${r}">${r}</option>`).join('');
        }
    },

    async populateStudentForm() {
        const selKelas = document.getElementById('input-kelas');
        const selRuang = document.getElementById('input-ruangan');
        
        if(selKelas) {
            selKelas.innerHTML = '<option value="">Memuat data...</option>';
            const classes = await DB.getClassList();
            selKelas.innerHTML = classes.length === 0 
                 ? `<option value="">Belum ada kelas</option>`
                 : `<option value="">-- Pilih Kelas --</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        if(selRuang) {
            selRuang.innerHTML = '<option value="">Memuat data...</option>';
            const rooms = await DB.getRoomList();
             if (rooms.length === 0) {
                 selRuang.innerHTML = `<option value="">Belum ada ruangan</option>`;
            } else {
                selRuang.innerHTML = `<option value="">-- Pilih Ruangan --</option>` + rooms.map(r => `<option value="${r}">${r}</option>`).join('');
            }
        }
    },

    async populateBulkDropdowns() {
        const selClass = document.getElementById('bulk-input-class');
        const selRoom = document.getElementById('bulk-input-room');
        const selExam = document.getElementById('bulk-input-exam'); 

        if (selClass) {
            selClass.innerHTML = '<option value="">Sedang memuat...</option>';
            const classes = await DB.getClassList();
            selClass.innerHTML = classes.length === 0 
                ? '<option value="">Belum ada data kelas</option>' 
                : `<option value="">-- Pilih Kelas Tujuan --</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
        }
        if (selRoom) {
            selRoom.innerHTML = '<option value="">Sedang memuat...</option>';
            const rooms = await DB.getRoomList();
            selRoom.innerHTML = rooms.length === 0 
                ? '<option value="">Belum ada data ruangan</option>' 
                : `<option value="">-- Pilih Ruangan Tujuan --</option>` + rooms.map(r => `<option value="${r}">${r}</option>`).join('');
        }
        if (selExam) {
            selExam.innerHTML = '<option value="">Sedang memuat...</option>';
            const exams = await DB.getExamList(); 
            selExam.innerHTML = exams.length === 0 
                ? '<option value="">Tidak ada ujian aktif</option>' 
                : `<option value="">-- Pilih Ujian --</option>` + exams.map(e => `<option value="${e.id}">${e.nama_ujian}</option>`).join('');
        }
    },

    async loadSettingsData() {
        const data = await DB.getTokenSettings();
        if(data) {
            if(Utils.getEl('setting-token-display')) Utils.getEl('setting-token-display').innerText = data.token_code;
            if(Utils.getEl('token-duration')) Utils.getEl('token-duration').value = data.token_duration;
            if(Utils.getEl('toggle-auto-token')) Utils.getEl('toggle-auto-token').checked = data.auto_refresh;
        }
    },

    // --- RENDER TABEL & LIST ---
    async renderStudents(useCache = false) {
        if(!useCache) { this.selectedItems = []; this.updateBulkButtonUI(); }

        const tbody = Utils.getEl('table-students-body');
        if (!useCache || STATE.cache.students.length === 0) {
            tbody.innerHTML = `<tr><td colspan="13" class="text-center py-8"><span class="animate-spin">⏳</span> Memuat...</td></tr>`;
            STATE.cache.students = await DB.getStudents();
        }

        const filterClass = Utils.getEl('filter-class')?.value || 'Semua';
        const filterRoom = Utils.getEl('filter-room')?.value || 'Semua';

        const html = STATE.cache.students.map((s, i) => {
            if (filterClass !== 'Semua' && s.kelas !== filterClass) return '';
            if (filterRoom !== 'Semua' && s.ruangan !== filterRoom) return '';

            const passwordHtml = `
                <div class="flex items-center justify-center gap-2">
                    <span id="pass-text-${i}" class="font-mono text-xs tracking-widest">***</span>
                    <button onclick="View.togglePass(${i}, '${Utils.escapeHTML(s.pass)}')" class="text-slate-400 hover:text-blue-600"><i data-feather="eye" class="w-3.5 h-3.5"></i></button>
                </div>`;

            return `
            <tr class="border-b hover:bg-slate-50 transition group-row">
                <td class="px-2 py-3 text-center">
                    <input type="checkbox" class="row-checkbox w-3.5 h-3.5" 
                        value="${Utils.escapeHTML(s.id_peserta)}"
                        ${View.selectedItems.includes(s.id_peserta) ? 'checked' : ''}
                        onchange="View.toggleSelect('${Utils.escapeHTML(s.id_peserta)}', this.checked)">
                </td>
                <td class="px-2 py-3 text-center relative">
                    <button onclick="toggleActionDropdown('stu-${i}', event)" class="bg-blue-50 p-1 rounded hover:bg-blue-100 text-blue-600"><i data-feather="more-horizontal" class="w-3.5 h-3.5"></i></button>
                    <div id="dropdown-stu-${i}" class="action-dropdown text-left z-50">
                        <button onclick="View.nav('add-student')" class="block w-full text-left px-4 py-2 text-xs hover:bg-slate-50">Edit Data</button>
                        <button onclick="View.modals.confirmDelete('${Utils.escapeHTML(s.id_peserta)}', 'student')" class="block w-full text-left px-4 py-2 text-xs hover:bg-red-50 text-red-600">Hapus</button>
                    </div>
                </td>
                <td class="px-2 py-3 text-center text-[10px]">${i + 1}</td>
                <td class="px-2 py-3 font-mono text-xs">${Utils.escapeHTML(s.username)}</td>
                <td class="px-2 py-3 text-center">${passwordHtml}</td>
                <td class="px-2 py-3 font-bold text-xs uppercase">${Utils.escapeHTML(s.nama)}</td>
                <td class="px-2 py-3 text-xs">${Utils.escapeHTML(s.id_peserta)}</td>
                <td class="px-2 py-3"><span class="bg-indigo-50 text-indigo-600 px-2 py-0.5 rounded text-[10px] font-bold">${Utils.escapeHTML(s.kelas)}</span></td>
                <td class="px-2 py-3 text-xs">${Utils.escapeHTML(s.ruangan)}</td>
                <td class="px-2 py-3 text-center"><span class="bg-slate-100 px-1.5 py-0.5 rounded text-[10px] font-bold">${Utils.escapeHTML(s.sesi)}</span></td>
                <td class="px-2 py-3 text-xs">${Utils.escapeHTML(s.sekolah)}</td>
                <td class="px-2 py-3 text-xs">${Utils.escapeHTML(s.agama)}</td>
                <td class="px-2 py-3 text-xs italic">${Utils.escapeHTML(s.catatan)}</td>
            </tr>`;
        }).join('');
        tbody.innerHTML = html || `<tr><td colspan="13" class="text-center py-4 text-xs">Data kosong.</td></tr>`;
        if (typeof feather !== 'undefined') feather.replace();
    },

    async renderClasses() {
        this.selectedItems = []; 
        this.updateBulkButtonUI();
        const tbody = Utils.getEl('table-classes-body');
        STATE.cache.classes = await DB.getClasses();
        
        const html = STATE.cache.classes.map((item, i) => `
            <tr class="border-b hover:bg-slate-50 transition">
                <td class="px-4 py-3 text-center">
                    <input type="checkbox" class="row-checkbox w-3.5 h-3.5" 
                        onchange="View.toggleSelect('${Utils.escapeHTML(item.name)}', this.checked)">
                </td>
                <td class="px-4 py-3 text-center text-xs">${i + 1}</td>
                <td class="px-4 py-3 font-mono font-bold text-xs">${Utils.escapeHTML(item.code)}</td>
                <td class="px-4 py-3 font-bold text-xs uppercase">${Utils.escapeHTML(item.name)}</td>
                <td class="px-4 py-3 text-xs italic">${Utils.escapeHTML(item.desc)}</td>
                <td class="px-4 py-3">
                    <button onclick="View.navToStudentFilter('kelas', '${Utils.escapeHTML(item.name)}')" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1">
                        <i data-feather="users" class="w-3 h-3"></i> (${item.count || 0}) Peserta
                    </button>
                </td>
                <td class="px-4 py-3 text-[10px]">${item.date}</td>
                <td class="px-4 py-3 text-center relative">
                    <button onclick="toggleActionDropdown('cls-${i}', event)" class="bg-slate-100 p-1.5 rounded hover:bg-slate-200 text-slate-600">
                        <i data-feather="more-horizontal" class="w-3.5 h-3.5"></i>
                    </button>
                    <div id="dropdown-cls-${i}" class="action-dropdown text-left z-50 right-0 origin-top-right">
                        <button onclick="View.modals.openEditClass('${item.id}')" class="block w-full text-left px-4 py-2 text-xs hover:bg-slate-50 text-blue-600">Edit</button>
                        <button onclick="View.modals.confirmDelete('${item.id}', 'class')" class="block w-full text-left px-4 py-2 text-xs hover:bg-red-50 text-red-600">Hapus</button>
                    </div>
                </td>
            </tr>`).join('');
        tbody.innerHTML = html;
        if (typeof feather !== 'undefined') feather.replace();
    },

    async renderRooms() {
        this.selectedItems = [];
        this.updateBulkButtonUI();
        const tbody = Utils.getEl('table-rooms-body');
        STATE.cache.rooms = await DB.getRooms();
        
        const html = STATE.cache.rooms.map((item, i) => `
            <tr class="border-b hover:bg-slate-50 transition">
                <td class="px-4 py-3 text-center">
                    <input type="checkbox" class="row-checkbox w-3.5 h-3.5" 
                        onchange="View.toggleSelect('${Utils.escapeHTML(item.name)}', this.checked)">
                </td>
                <td class="px-4 py-3 text-center text-xs">${i + 1}</td>
                <td class="px-4 py-3 font-mono font-bold text-xs">${Utils.escapeHTML(item.code)}</td>
                <td class="px-4 py-3 font-bold text-xs uppercase">${Utils.escapeHTML(item.name)}</td>
                <td class="px-4 py-3 text-xs italic">${Utils.escapeHTML(item.desc)}</td>
                <td class="px-4 py-3">
                     <button onclick="View.navToStudentFilter('ruangan', '${Utils.escapeHTML(item.name)}')" class="text-xs font-bold text-blue-600 hover:underline flex items-center gap-1">
                        <i data-feather="users" class="w-3 h-3"></i> (${item.count || 0}) Peserta
                    </button>
                </td>
                <td class="px-4 py-3 text-[10px]">${item.date}</td>
                <td class="px-4 py-3 text-center relative">
                     <button onclick="toggleActionDropdown('room-${i}', event)" class="bg-slate-100 p-1.5 rounded hover:bg-slate-200 text-slate-600">
                        <i data-feather="more-horizontal" class="w-3.5 h-3.5"></i>
                    </button>
                    <div id="dropdown-room-${i}" class="action-dropdown text-left z-50 right-0 origin-top-right">
                        <button onclick="View.modals.openEditRoom('${item.id}')" class="block w-full text-left px-4 py-2 text-xs hover:bg-slate-50 text-blue-600">Edit</button>
                        <button onclick="View.modals.confirmDelete('${item.id}', 'room')" class="block w-full text-left px-4 py-2 text-xs hover:bg-red-50 text-red-600">Hapus</button>
                    </div>
                </td>
            </tr>`).join('');
        tbody.innerHTML = html;
        if (typeof feather !== 'undefined') feather.replace();
    },

    // --- NAVIGASI FILTER & LAINNYA ---
    navToStudentFilter(type, value) { 
        this.nav('students');
        setTimeout(() => {
            if(type === 'kelas') {
                const select = Utils.getEl('filter-class');
                if(select) { select.value = value; select.dispatchEvent(new Event('change')); }
            } else if (type === 'ruangan') {
                const select = Utils.getEl('filter-room');
                if(select) { select.value = value; select.dispatchEvent(new Event('change')); }
            }
            this.renderStudents(true); 
        }, 100); 
    }, 

    togglePass(index, realPass) {
        const textEl = Utils.getEl(`pass-text-${index}`);
        const iconEl = Utils.getEl(`icon-pass-${index}`);
        
        if (!textEl) return;
        if (textEl.innerText === '***') {
            textEl.innerText = realPass;
            textEl.classList.add('text-blue-600', 'font-bold');
            if(iconEl) iconEl.classList.add('text-blue-600'); 
        } else {
            textEl.innerText = '***';
            textEl.classList.remove('text-blue-600', 'font-bold');
            if(iconEl) iconEl.classList.remove('text-blue-600');
        }
    },

    async updateDashboard() {
        const btn = Utils.getEl('btn-refresh-dash');
        const icon = Utils.getEl('icon-refresh');
        const text = Utils.getEl('text-refresh');

        if (icon) icon.classList.add('animate-spin'); 
        if (text) text.innerText = "Updating...";     
        if (btn) btn.classList.add('bg-slate-100', 'text-blue-600'); 

        try {
            const [
                totalSiswa, siswaOnline,
                totalPengawas, pengawasOnline,
                totalAdmin, adminOnline,
                totalKelas, totalRuang,
                totalUjian, ujianAktif,
                realHttpHits,            
                totalRecordedDevices    
            ] = await Promise.all([
                DB.getCount('students'), DB.getStudentOnline(),
                DB.getUserTotalByRole('pengawas'), DB.getUserOnline('pengawas'),
                DB.getUserTotalByRole('admin'), DB.getUserOnline('admin'),
                DB.getCount('classes'), DB.getCount('rooms'),
                DB.getCount('exams'), DB.getActiveExams(),
                DB.getSiteStats(),              
                DB.getCount('device_logs')    
            ]);

            const map = {
                'stat-students': totalSiswa, 'stat-online': siswaOnline,
                'stat-proctor-total': totalPengawas, 'stat-proctor-online': pengawasOnline,
                'stat-admin-total': totalAdmin, 'stat-admin-online': adminOnline,
                'stat-classes': totalKelas, 'stat-rooms': totalRuang,
                'stat-exams': totalUjian, 'stat-exams-active': ujianAktif,
                'stat-http': realHttpHits, 
                'stat-active-devices': totalRecordedDevices 
            };

            for (const [id, val] of Object.entries(map)) {
                if(Utils.getEl(id)) Utils.getEl(id).innerText = val;
            }
        } catch (e) { console.error("Dashboard error:", e); } 
        finally {
            if (icon) icon.classList.remove('animate-spin');
            if (text) text.innerText = "Refresh";
            if (btn) btn.classList.remove('bg-slate-100', 'text-blue-600');
        }
    },

    async renderExamList() {
        const container = Utils.getEl('exam-list-body');
        if (!container) return;
        container.innerHTML = `<tr><td colspan="8" class="text-center py-8">⏳ Memuat...</td></tr>`;
        STATE.cache.exams = await DB.getExams();
        
        const html = STATE.cache.exams.map((ex, i) => {
            const statusClass = ex.status === 'Aktif' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500';
            return `
            <tr class="border-b hover:bg-slate-50 transition-colors">
                <td class="w-24 text-center py-3 relative">
                    <div class="inline-flex rounded-md shadow-sm">
                        <button onclick="View.openExamDetail('${Utils.escapeHTML(ex.name)}')" class="px-3 py-1.5 text-xs font-bold text-white bg-blue-600 rounded-l-lg">Detail</button>
                        <button onclick="toggleActionDropdown('exam-${i}', event)" class="px-2 py-1.5 text-xs font-bold text-white bg-blue-600 rounded-r-lg border-l border-blue-700"><i data-feather="chevron-down" class="w-3 h-3"></i></button>
                    </div>
                    <div id="dropdown-exam-${i}" class="action-dropdown text-left z-50">
                        <button onclick="View.openExamSettings('${Utils.escapeHTML(ex.name)}', ${ex.id})" class="block w-full text-left px-4 py-1.5 hover:bg-slate-50">Pengaturan</button>
                        <button onclick="ExamController.toggleStatus(${i})" class="block w-full text-left px-4 py-1.5 font-bold">${ex.status === 'Aktif' ? 'Nonaktifkan' : 'Aktifkan'}</button>
                        <button onclick="ExamController.delete(${i})" class="block w-full text-left px-4 py-1.5 hover:bg-red-50 text-red-500">Hapus</button>
                    </div>
                </td>
                <td class="py-3 px-4 font-bold text-xs uppercase">${Utils.escapeHTML(ex.name)}</td>
                <td class="py-3 px-4 text-xs">(${ex.peserta}) Peserta</td>
                <td class="py-3 px-4 text-xs">${Utils.escapeHTML(ex.pengelola)}</td>
                <td class="py-3 px-4 font-mono font-bold text-xs">${Utils.escapeHTML(ex.alokasi)}</td>
                <td class="py-3 px-4"><span class="${statusClass} px-2 py-1 rounded text-[10px] font-bold uppercase">${ex.status}</span></td>
                <td class="py-3 px-4 text-xs">-</td>
                <td class="py-3 px-4 text-xs">-</td>
            </tr>`;
        }).join('');
        container.innerHTML = html || `<tr><td colspan="8" class="text-center py-4">Belum ada ujian.</td></tr>`;
        if (typeof feather !== 'undefined') feather.replace();
    },

    async renderQuestions() {
        const tbody = Utils.getEl('question-list-body');
        if (!tbody) return;
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-8">⏳ Memuat...</td></tr>`;
        STATE.cache.questions = await DB.getQuestions(); 
        
        const html = STATE.cache.questions.map((q, i) => `
            <tr class="border-b">
                <td class="px-4 py-3 text-xs">${i+1}</td>
                <td class="px-4 py-3 text-xs truncate max-w-xs">${Utils.escapeHTML(q.text || 'Tanpa Teks')}</td>
                <td class="px-4 py-3"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-[10px] uppercase">${q.type}</span></td>
                <td class="px-4 py-3">${q.media ? '<i data-feather="paperclip" class="w-3 h-3"></i>' : '-'}</td>
                <td class="px-4 py-3 text-center"><button class="text-red-500"><i data-feather="trash-2" class="w-4 h-4"></i></button></td>
            </tr>`).join('');
        tbody.innerHTML = html || `<tr><td colspan="5" class="text-center py-4 text-xs text-slate-400">Belum ada soal.</td></tr>`;
        feather.replace();
    },

    async renderConnections() {
        const tbody = Utils.getEl('table-connections-body');
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8"><span class="animate-spin">⏳</span> Memuat data perangkat...</td></tr>`;
        STATE.cache.logs = await DB.getDeviceLogs(); 
        
        if (STATE.cache.logs.length === 0) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4">Belum ada riwayat.</td></tr>`;
            return;
        }

        const html = STATE.cache.logs.map((log, i) => `
            <tr onclick="View.showConnectionDetail(${i})" class="border-b hover:bg-blue-50 cursor-pointer transition group">
                <td class="px-4 py-3 text-center text-[10px]">${i + 1}</td>
                <td class="px-4 py-3 font-mono text-xs font-bold text-blue-600 group-hover:underline">${Utils.escapeHTML(log.device_id)}</td>
                <td class="px-4 py-3 text-xs">
                    <div class="flex items-center gap-2">
                        <i data-feather="${log.device_name.includes('Mobile') || log.device_name.includes('Android') ? 'smartphone' : 'monitor'}" class="w-3 h-3 text-slate-400"></i>
                        ${Utils.escapeHTML(log.device_name)}
                    </div>
                </td>
                <td class="px-4 py-3 font-mono text-xs text-slate-500">${Utils.escapeHTML(log.ip_address)}</td>
                <td class="px-4 py-3 text-xs">
                    ${new Date(log.last_seen).toLocaleString('id-ID', {day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'})}
                </td>
                <td class="px-4 py-3 text-center text-xs font-bold bg-slate-50 rounded">${log.visit_count || 1}</td>
            </tr>
        `).join('');
        tbody.innerHTML = html;
        feather.replace();
    },

    showConnectionDetail(index) {
        const log = STATE.cache.logs[index];
        if(!log) return;
        Utils.getEl('detail-device-id').innerText = log.device_id;
        Utils.getEl('detail-device-name').innerText = log.device_name;
        Utils.getEl('detail-ip').innerText = log.ip_address;
        Utils.getEl('detail-last-seen').innerText = new Date(log.last_seen).toLocaleString('id-ID', {weekday:'long', day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit'});
        Utils.getEl('detail-visits').innerText = log.visit_count || 1;
        Utils.getEl('modal-connection-detail').classList.remove('hidden');
    },

    switchBankTab(tab) {
        ['view-bank-soal', 'view-bank-ujian', 'view-exam-detail', 'view-exam-participants'].forEach(id => {
            if(Utils.getEl(id)) Utils.getEl(id).classList.add('hidden-view');
        });
        ['tab-soal', 'tab-ujian'].forEach(id => {
            if(Utils.getEl(id)) Utils.getEl(id).classList.remove('active');
        });
        
        if(Utils.getEl('view-bank-'+tab)) Utils.getEl('view-bank-'+tab).classList.remove('hidden-view');
        if(Utils.getEl('tab-'+tab)) Utils.getEl('tab-'+tab).classList.add('active');
        
        if(tab === 'ujian') this.renderExamList();
        if(tab === 'soal') this.renderQuestions();
    },

    switchSettingTab(e, tabId) {
        document.querySelectorAll('.setting-content').forEach(c => c.classList.add('hidden-view'));
        const target = Utils.getEl('set-' + tabId);
        if(target) target.classList.remove('hidden-view');
        
        document.querySelectorAll('.settings-nav-item').forEach(b => b.classList.remove('active'));
        if (e && e.currentTarget) e.currentTarget.classList.add('active');
    },

    modals: {
        openEditClass(id = null) {
            STATE.editing.classId = id;
            const target = STATE.cache.classes.find(c => String(c.id) === String(id));
            Utils.getEl('edit-class-name').value = target ? target.name : '';
            Utils.getEl('edit-class-desc').value = target ? target.desc : '';
            Utils.getEl('modal-class-title').innerText = id ? "Edit Data Kelas" : "Tambah Kelas Baru";
            Utils.getEl('modal-edit-class').classList.remove('hidden');
        },
        closeEditClass() { Utils.getEl('modal-edit-class').classList.add('hidden'); STATE.editing.classId = null; },
        
        openEditRoom(id = null) {
            STATE.editing.roomId = id;
            const target = STATE.cache.rooms.find(r => String(r.id) === String(id));
            Utils.getEl('edit-room-name').value = target ? target.name : '';
            Utils.getEl('edit-room-desc').value = target ? target.desc : '';
            Utils.getEl('modal-room-title').innerText = id ? "Edit Ruangan" : "Tambah Ruangan";
            Utils.getEl('modal-edit-room').classList.remove('hidden');
        },
        closeEditRoom() { Utils.getEl('modal-edit-room').classList.add('hidden'); STATE.editing.roomId = null; },

        confirmDelete(id, type) {
            STATE.editing.pendingDeleteId = id;
            STATE.editing.pendingDeleteType = type;
            Utils.getEl('modal-confirm-delete').classList.remove('hidden');
        },

        showSuccess(msg) {
            const modal = Utils.getEl('modal-success');
            Utils.getEl('msg-success').innerText = msg;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.querySelector('.bg-slate-900\\/40').classList.remove('opacity-0');
                modal.querySelector('.relative').classList.remove('scale-95', 'opacity-0');
                modal.querySelector('.relative').classList.add('scale-100', 'opacity-100');
            }, 10);
        },

        closeSuccess() {
            const modal = Utils.getEl('modal-success');
            if(!modal) return;
            modal.querySelector('.bg-slate-900\\/40').classList.add('opacity-0');
            modal.querySelector('.relative').classList.remove('scale-100', 'opacity-100');
            modal.querySelector('.relative').classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        },

        showError(title, msg) {
            const modal = Utils.getEl('modal-error');
            Utils.getEl('error-title').innerText = title;
            Utils.getEl('error-message').innerText = msg;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.add('scale-100');
            }, 10);
        },
        closePin() { Utils.getEl('modal-pin').classList.add('hidden'); }
    },

    openExamDetail(name) {
        Utils.getEl('view-bank-ujian').classList.add('hidden-view');
        Utils.getEl('view-exam-detail').classList.remove('hidden-view');
        Utils.getEl('detail-exam-title').innerText = name;
    },
    closeExamDetail() {
        Utils.getEl('view-exam-detail').classList.add('hidden-view');
        Utils.getEl('view-bank-ujian').classList.remove('hidden-view');
    },
    openExamSettings(n, id) {
        STATE.editing.examId = id;
        const exam = STATE.cache.exams.find(e => e.id == id);
        if (exam) {
            Utils.getEl('input-exam-name').value = exam.name;
            Utils.getEl('sched-alloc').value = parseInt(exam.alokasi) || 90;
            Utils.getEl('input-exam-status').value = (exam.status === 'Aktif') ? '1' : '0';
        }
        Utils.getEl('panel-questions').classList.add('hidden-view');
        Utils.getEl('view-exam-settings').classList.remove('hidden-view');
    },
    closeExamSettings() {
        Utils.getEl('view-exam-settings').classList.add('hidden-view');
        Utils.getEl('panel-questions').classList.remove('hidden-view');
        this.switchBankTab('ujian');
    }
};
// ============================================================================
// 6. BUSINESS LOGIC CONTROLLERS
// ============================================================================
const StudentController = {
    async save() {
        const btn = document.querySelector('button[onclick="saveStudentData()"]');
        const data = {
            nama_lengkap: Utils.getEl('input-nama').value,
            id_peserta: Utils.getEl('input-id-peserta').value,
            username: Utils.getEl('input-username').value,
            password: Utils.getEl('input-password').value,
            kelas: Utils.getEl('input-kelas').value,
            ruangan: Utils.getEl('input-ruangan').value,
            sesi: Utils.getEl('input-sesi').value
        };
        if (!data.nama_lengkap || !data.username) return alert("Lengkapi data!");
        
        Utils.setLoading(btn, true);
        const { error } = await DB.addStudent(data);
        Utils.setLoading(btn, false);
        
        if (!error) {
            View.modals.showSuccess("Siswa berhasil ditambahkan!");
            View.nav('students');
        } else alert(error.message);
    }
};

const ClassController = {
    async save() {
        const btn = document.querySelector('#modal-edit-class button[onclick="saveClassData()"]');
        const name = Utils.getEl('edit-class-name').value;
        const desc = Utils.getEl('edit-class-desc').value;
        const isEdit = STATE.editing.classId;
        
        if(!name) return alert("Nama kelas wajib!");
        Utils.setLoading(btn, true);
        
        let res = isEdit ? await DB.updateClass(isEdit, { nama_kelas: name, deskripsi: desc }) 
                         : await DB.addClass({ nama_kelas: name, kode_kelas: "KLS-"+Date.now(), deskripsi: desc });
                          
        Utils.setLoading(btn, false);
        if(!res.error) {
            View.modals.closeEditClass();
            View.modals.showSuccess("Data kelas disimpan");
            View.renderClasses();
        }
    }
};

const RoomController = {
    async save() {
        const btn = document.querySelector('#modal-edit-room button[onclick="saveRoomData()"]');
        const name = Utils.getEl('edit-room-name').value;
        const desc = Utils.getEl('edit-room-desc').value;
        const isEdit = STATE.editing.roomId;
        
        if(!name) return alert("Nama wajib!");
        Utils.setLoading(btn, true);
        
        let res = isEdit ? await DB.updateRoom(isEdit, { nama_ruangan: name, deskripsi: desc })
                         : await DB.addRoom({ nama_ruangan: name, kode_ruangan: "R-"+Date.now(), deskripsi: desc });
                          
        Utils.setLoading(btn, false);
        if(!res.error) {
            View.modals.closeEditRoom();
            View.modals.showSuccess("Data ruangan disimpan");
            View.renderRooms();
        }
    },
    async delete() {
        const { pendingDeleteId: id, pendingDeleteType: type } = STATE.editing;
        Utils.getEl('modal-confirm-delete').classList.add('hidden');
        
        let res;
        if(type === 'class') { res = await DB.deleteClass(id); View.renderClasses(); }
        else if(type === 'room') { res = await DB.deleteRoom(id); View.renderRooms(); }
        else if(type === 'exam') { res = await DB.deleteExam(id); View.renderExamList(); }
        else if(type === 'student') { 
             const { error } = await db.from('students').delete().eq('id_peserta', id); 
             if(!error) View.renderStudents(false);
        }
        if(!res?.error) View.modals.showSuccess("Data berhasil dihapus");
    }
};

const ExamController = {
    async add() {
        const name = prompt("Nama Ujian:");
        if(name) {
            await DB.addExam({ nama_ujian: name, status: 'Tidak Aktif', alokasi: '90 Menit' });
            View.renderExamList();
            View.updateDashboard();
        }
    },
    async toggleStatus(idx) {
        const exam = STATE.cache.exams[idx];
        const newStatus = exam.status === 'Aktif' ? 'Tidak Aktif' : 'Aktif';
        await DB.updateExam(exam.id, { status: newStatus });
        View.renderExamList();
        View.updateDashboard();
    },
    async delete(idx) {
        const exam = STATE.cache.exams[idx];
        View.modals.confirmDelete(exam.id, 'exam');
    },
    async saveSettings(section) {
        const id = STATE.editing.examId;
        if(!id) return;
        let data = {};
        if (section === 'info') data = { 
            nama_ujian: Utils.getEl('input-exam-name').value, 
            status: (Utils.getEl('input-exam-status').value == '1') ? 'Aktif' : 'Tidak Aktif' 
        };
        await DB.updateExam(id, data);
        View.modals.showSuccess("Pengaturan tersimpan");
        View.renderExamList();
    }
};
// ============================================================================
// BULK CONTROLLER (LOGIKA EKSEKUSI MASSAL)
// ============================================================================
const BulkController = {
    // 1. Fungsi Execute (Dipanggil saat tombol Simpan di Modal diklik)
    async execute(actionType) {
        const items = View.selectedItems; // Ambil ID siswa yang dicentang
        if (items.length === 0) return alert("Tidak ada siswa yang dipilih!");

        const btnSave = event.target; // Tombol yang diklik (untuk loading effect)
        let inputVal = "";
        let dbField = "";
        let modalId = "";

        // --- TENTUKAN LOGIKA BERDASARKAN ACTION TYPE ---
        
        // A. PINDAH KELAS
        if (actionType === 'move_class') {
            inputVal = document.getElementById('bulk-input-class').value;
            dbField = 'kelas';
            modalId = 'modal-move-class';
            if (!inputVal) return alert("Silakan pilih kelas tujuan!");
        } 
        
        // B. PINDAH RUANGAN
        else if (actionType === 'move_room') {
            inputVal = document.getElementById('bulk-input-room').value;
            dbField = 'ruangan';
            modalId = 'modal-move-room';
            if (!inputVal) return alert("Silakan pilih ruangan tujuan!");
        } 
        
        // C. PINDAH SESI
        else if (actionType === 'move_session') {
            inputVal = document.getElementById('bulk-input-session').value;
            dbField = 'sesi';
            modalId = 'modal-move-session';
            if (!inputVal) return alert("Silakan isi nomor sesi!");
        }

        // D. DAFTARKAN UJIAN
        else if (actionType === 'register_exam') {
            inputVal = document.getElementById('bulk-input-exam').value; // Ini Exam ID
            modalId = 'modal-register-exam';
            if (!inputVal) return alert("Silakan pilih ujian!");
            
            // Eksekusi Khusus untuk Register Ujian
            Utils.setLoading(btnSave, true, "Mendaftarkan...");
            const { error } = await DB.registerExamParticipants(inputVal, items);
            Utils.setLoading(btnSave, false);

            if (!error) {
                document.getElementById(modalId).classList.add('hidden');
                View.modals.showSuccess(`Berhasil mendaftarkan ${items.length} siswa ke ujian!`);
                // Reset Seleksi
                View.selectedItems = [];
                View.updateBulkButtonUI();
                document.querySelectorAll('.row-checkbox').forEach(c => c.checked = false);
            } else {
                alert("Gagal: " + error.message);
            }
            return; // Stop di sini, karena logic di bawah untuk Update Siswa
        }

        // --- EKSEKUSI UPDATE SISWA (Kelas, Ruangan, Sesi) ---
        Utils.setLoading(btnSave, true, "Menyimpan...");
        
        // Siapkan objek update, misal: { kelas: 'XII IPA 1' }
        const updateData = {};
        updateData[dbField] = inputVal;

        // Panggil DB
        const { error } = await DB.bulkUpdateStudents('id_peserta', items, updateData);
        
        Utils.setLoading(btnSave, false);

        if (!error) {
            // Tutup Modal
            document.getElementById(modalId).classList.add('hidden');
            
            View.modals.showSuccess("Data berhasil diperbarui!");
            
            // Refresh Tabel Siswa
            View.renderStudents(true);
            
            // Reset Seleksi & Tombol
            View.selectedItems = [];
            View.updateBulkButtonUI();
            
            // Uncheck semua checkbox
            document.querySelectorAll('.row-checkbox').forEach(c => c.checked = false);
        } else {
            alert("Gagal memperbarui data: " + error.message);
        }
    },

    // 2. Fungsi Action (Masih dipakai untuk Delete & Random Pass yang tidak butuh Modal Input)
    async action(type) {
        const items = View.selectedItems;
        if (items.length === 0) return alert("Pilih data terlebih dahulu!");

        // HAPUS PESERTA
        if (type === 'delete') {
            if (!confirm(`Yakin ingin MENGHAPUS ${items.length} siswa yang dipilih? Data tidak bisa kembali!`)) return;
            
            // Tampilkan loading di dropdown menu (opsional)
            const { error } = await DB.bulkDeleteStudents('id_peserta', items);
            
            if (!error) {
                alert("Data berhasil dihapus!");
                View.renderStudents(true);
                View.selectedItems = [];
                View.updateBulkButtonUI();
            } else {
                alert("Gagal: " + error.message);
            }
        }
        
        // RANDOM PASSWORD
        else if (type === 'random_pass') {
            if (!confirm(`Reset password acak untuk ${items.length} siswa terpilih?`)) return;
            
            const newPass = Math.random().toString(36).slice(-6); 
            const { error } = await DB.bulkUpdateStudents('id_peserta', items, { password: newPass, pass: newPass });
            
            if(!error) {
                alert(`Berhasil! Password siswa diubah menjadi: ${newPass}`);
                View.renderStudents(true);
            }
        }
    }
};
// ============================================================================
// SETTINGS CONTROLLER (TOKEN & KONFIGURASI)
// ============================================================================
const SettingsController = {
    async generateToken() {
        const btn = event.target.closest('button');
        Utils.setLoading(btn, true, "Generating...");
        
        try {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let newToken = "";
            for (let i = 0; i < 6; i++) newToken += chars.charAt(Math.floor(Math.random() * chars.length));
            
            // Simpan ke Database
            const { error } = await DB.updateToken(newToken);
            
            if (error) throw error;
            View.modals.showSuccess("Token berhasil diperbarui!");
            
        } catch (e) {
            alert("Gagal: " + e.message);
        } finally {
            Utils.setLoading(btn, false);
            btn.innerHTML = `<i data-feather="refresh-cw" class="w-4 h-4"></i> Generate Baru`;
            feather.replace();
        }
    },

    async saveTokenSettings() {
        const btn = event.target.closest('button');
        const duration = Utils.getEl('token-duration').value;
        const autoRefresh = Utils.getEl('toggle-auto-token').checked;

        Utils.setLoading(btn, true, "Menyimpan...");
        
        const { error } = await DB.updateTokenConfig(duration, autoRefresh);
        
        Utils.setLoading(btn, false);
        
        if (!error) {
            View.modals.showSuccess("Pengaturan token disimpan!");
        } else {
            alert("Gagal menyimpan: " + error.message);
        }
    }
};
// ============================================================================
// 7. REALTIME FEATURES (TOKEN + ANIMASI SVG)
// ============================================================================
const RealtimeFeatures = {
    init() {
        this.initToken();
        this.initPresence();
        this.initTraffic();
    },

    initToken() {
        db.channel('public:exam_settings')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'exam_settings' }, (payload) => {
                this.updateTokenUI(payload.new);
            })
            .subscribe();
        db.from('exam_settings').select('*').eq('id', 1).single().then(({data}) => { if(data) this.updateTokenUI(data); });
    },

    updateTokenUI(data) {
        if(Utils.getEl('dash-token')) Utils.getEl('dash-token').innerText = data.token_code;
        if(data.expired_at) this.startTimer(new Date(data.expired_at));
    },

    // [RESTORED] Logika Animasi Lingkaran Biru
    // Di dalam objek RealtimeFeatures
    startTimer(target) {
        if(STATE.intervals.tokenTimer) clearInterval(STATE.intervals.tokenTimer);
        const circle = document.querySelector('.progress-ring__circle');
        const timerText = Utils.getEl('dash-timer');
        // Asumsi 15 menit full (sesuaikan dengan alokasi token Anda)
        const totalDuration = 15 * 60 * 1000; 
    
        STATE.intervals.tokenTimer = setInterval(() => {
            const now = new Date();
            const diff = target - now;
            
            // --- PERBAIKAN POIN 1: Logika Expired ---
            if(diff <= 0) {
                clearInterval(STATE.intervals.tokenTimer);
                if(timerText) {
                    timerText.innerText = "EXPIRED";
                    timerText.classList.remove('text-slate-700');
                    timerText.classList.add('text-red-500', 'font-bold'); // Merah tebal
                }
                
                // Buat lingkaran kosong (putih)
                if (circle) {
                    const radius = circle.r.baseVal.value;
                    const circumference = radius * 2 * Math.PI;
                    circle.style.strokeDasharray = `${circumference} ${circumference}`;
                    circle.style.strokeDashoffset = circumference; // Offset penuh = kosong
                }
                return;
            }
            // ----------------------------------------
    
            // Reset warna jika token diperbarui
            if(timerText && timerText.classList.contains('text-red-500')) {
                timerText.classList.remove('text-red-500', 'font-bold');
                timerText.classList.add('text-slate-700');
            }
    
            const m = Math.floor((diff/60000)%60).toString().padStart(2,'0');
            const s = Math.floor((diff/1000)%60).toString().padStart(2,'0');
            if(timerText) timerText.innerText = `${m}:${s}`;
    
            if (circle) {
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                circle.style.strokeDasharray = `${circumference} ${circumference}`;
                const percent = Math.max(0, (diff / totalDuration) * 100);
                const offset = circumference - (percent / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        }, 1000);
    },

    async regenerateToken() {
        const btn = document.querySelector('button[onclick="regenerateToken()"]');
        Utils.setLoading(btn, true, "...");
        try {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let newToken = "";
            for (let i = 0; i < 6; i++) newToken += chars.charAt(Math.floor(Math.random() * chars.length));
            const expiredAt = new Date(Date.now() + 15 * 60000); // 15 menit
            await db.from('exam_settings').update({ token_code: newToken, expired_at: expiredAt.toISOString() }).eq('id', 1);
        } catch(e) { alert(e.message); } 
        finally { btn.innerHTML = `<i data-feather="refresh-cw" class="w-4 h-4"></i> Generate Baru`; btn.disabled = false; feather.replace(); }
    },
    async initPresence() {
        if (STATE.realtime && STATE.realtime.presenceChannel) {
            await STATE.realtime.presenceChannel.unsubscribe();
            db.removeChannel(STATE.realtime.presenceChannel);
            STATE.realtime.presenceChannel = null;
        }

        const session = JSON.parse(localStorage.getItem('cbt_user_session'));
        const myRole = session ? session.role : 'guest'; 
        const myUsername = session ? session.username : 'anon';

        const room = db.channel('online_users_room', {
            config: { presence: { key: myUsername + '-' + Date.now() } },
        });

        if (!STATE.realtime) STATE.realtime = {};
        STATE.realtime.presenceChannel = room;

    room.on('presence', { event: 'sync' }, () => {
            const state = room.presenceState();
            const allUsers = Object.values(state).flat();

            const uniqueDeviceSet = new Set(allUsers.map(u => u.username));
            const totalUniqueDevices = uniqueDeviceSet.size;

            const countAdmin = new Set(allUsers.filter(u => u.userRole === 'admin').map(u => u.username)).size;
            const countPengawas = new Set(allUsers.filter(u => u.userRole === 'pengawas').map(u => u.username)).size;
            const countSiswa = new Set(allUsers.filter(u => u.userRole === 'siswa').map(u => u.username)).size;
            const totalSocket = allUsers.length;

            if(Utils.getEl('stat-admin-online')) Utils.getEl('stat-admin-online').innerText = countAdmin;
            if(Utils.getEl('stat-proctor-online')) Utils.getEl('stat-proctor-online').innerText = countPengawas;
            if(Utils.getEl('stat-online')) Utils.getEl('stat-online').innerText = countSiswa;
            
            if(Utils.getEl('stat-socket')) Utils.getEl('stat-socket').innerText = totalSocket;

            if(Utils.getEl('stat-active-devices')) {
                Utils.getEl('stat-active-devices').innerText = totalUniqueDevices;
            }
        });

        room.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await room.track({
                    online: true,
                    userRole: myRole,
                    username: myUsername
                });
            }
        });
    },

    async initTraffic() {
        try {
            await db.rpc('increment_hit');
        } catch (err) { console.warn("Setup increment_hit di Supabase dulu."); }

        db.channel('public:site_stats')
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'site_stats'}, (payload) => {
                if(Utils.getEl('stat-total-hits')) {
                    Utils.getEl('stat-total-hits').innerText = payload.new.total_hits;
                }
        }).subscribe();
        
        const { data } = await db.from('site_stats').select('total_hits').eq('id', 1).single();
        if(data && Utils.getEl('stat-total-hits')) {
            Utils.getEl('stat-total-hits').innerText = data.total_hits;
        }
    }
};

// ============================================================================
// 8. MAIN APP & TICKER
// ============================================================================
const App = {
    init() {
        console.log("CBT Pro Enterprise Loaded.");
        Auth.init();
        RealtimeFeatures.init();
        
        DB.incrementHit(); // Tambah counter HTTP
        DB.logDevice();    // Rekam Perangkat
        
        this.runTicker();
        if (typeof feather !== 'undefined') feather.replace();
        setInterval(() => {
            const el = Utils.getEl('admin-clock');
            if(el) el.innerText = new Date().toLocaleTimeString('id-ID', {hour12:false});
        }, 1000);
    },

    runTicker() {
        const el = Utils.getEl('dynamic-ticker');
        if(!el) return;
        const msg = CONFIG.TICKER_MESSAGES[STATE.ui.tickerIndex];
        el.innerHTML = msg.text;
        el.className = 'ticker-text ' + msg.anim;
        el.style.animation = 'none';
        el.offsetHeight; 
        el.style.animation = null; 
        setTimeout(() => {
            STATE.ui.tickerIndex = (STATE.ui.tickerIndex + 1) % CONFIG.TICKER_MESSAGES.length;
            this.runTicker();
        }, msg.duration);
    }
};

// ============================================================================
// 9. GLOBAL BRIDGES (AGAR HTML ONCLICK BERFUNGSI NORMAL)
// ============================================================================
window.adminNav = (id) => View.nav(id);
window.fetchAdminData = () => View.renderStudents(true);
window.saveStudentData = () => StudentController.save();
window.toggleAllStudents = (src) => document.querySelectorAll('.student-checkbox').forEach(c => c.checked = src.checked);

window.toggleActionDropdown = (i, e) => { 
    e.stopPropagation(); 
    document.querySelectorAll('.action-dropdown').forEach(d => d.classList.remove('show')); 
    const target = document.getElementById(`dropdown-${i}`);
    if(target) target.classList.toggle('show'); 
};
window.closeDropdowns = (e) => { 
    if(!e.target.closest('.action-dropdown')) document.querySelectorAll('.action-dropdown').forEach(d => d.classList.remove('show')); 
};

// Modals & Forms
window.openEditClassModal = () => View.modals.openEditClass();
window.closeEditClassModal = () => View.modals.closeEditClass();
window.saveClassData = () => ClassController.save();
window.openEditRoomModal = (id) => View.modals.openEditRoom(id);
window.closeEditRoomModal = () => View.modals.closeEditRoom();
window.saveRoomData = () => RoomController.save();
window.executeDelete = () => RoomController.delete();
window.prepareEditClass = (id) => View.modals.openEditClass(id);
window.deleteClass = (id) => View.modals.confirmDelete(id, 'class');
window.confirmDelete = (id, type) => View.modals.confirmDelete(id, type);

// Exams & Questions
window.addNewExam = () => ExamController.add();
window.openExamDetail = (name) => View.openExamDetail(name);
window.closeExamDetail = () => View.closeExamDetail();
window.openExamSettings = (n, id) => View.openExamSettings(n, id);
window.closeExamSettings = () => View.closeExamSettings();
window.saveSpecificSettings = (sec) => ExamController.saveSettings(sec);
window.switchBankTab = (tab) => View.switchBankTab(tab);
window.switchSettingTab = (e, tab) => View.switchSettingTab(e, tab);
window.updateRealtimeSummary = () => View.updateRealtimeSummary();
window.toggleExamStatus = (i) => ExamController.toggleStatus(i);
window.deleteExam = (i) => ExamController.delete(i);
window.saveQuestion = async () => {
    const text = Utils.getEl('q-text').value;
    const type = Utils.getEl('q-type').value;
    await DB.addQuestion({ text, type });
    Utils.getEl('modal-add-question').classList.add('hidden');
    View.renderQuestions();
};
window.openAddQuestionModal = () => Utils.getEl('modal-add-question').classList.remove('hidden');
window.renderAnswerInputs = () => { /* Logic render */ };
window.deleteQuestion = (i) => { if(confirm('Hapus?')) { STATE.cache.questions.splice(i,1); View.renderQuestions(); }};

// Auth & System
window.attemptLogin = () => Auth.login('log-user', 'log-pass', 'btn-login');
window.verifyAdminLoginReal = () => Auth.login('admin-user-input', 'admin-pass-input', 'btn-admin-login');
window.logoutAdmin = () => Auth.logout();
window.regenerateToken = () => RealtimeFeatures.regenerateToken();
window.updateDashboardStats = () => View.updateDashboard();
window.toggleSidebar = () => View.toggleSidebar();
window.toggleFullScreen = () => { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else if(document.exitFullscreen) document.exitFullscreen(); };
window.toggleProfileMenu = (e) => { e.stopPropagation(); Utils.getEl('profile-dropdown').classList.toggle('hidden'); };

// Modal Close Animations
window.closeSuccessModal = () => View.modals.closeSuccess(); 
window.closeErrorModal = () => {
    const modal = Utils.getEl('modal-error');
    modal.classList.add('opacity-0');
    setTimeout(() => modal.classList.add('hidden'), 300);
};

// Print Logic
window.handlePrint = () => {
    const content = Utils.getEl('card-preview-area').innerHTML;
    const win = window.open('', '', 'height=700,width=700');
    win.document.write('<html><head><title>Cetak Kartu</title>');
    win.document.write('<link rel="stylesheet" href="style.css">');
    win.document.write('</head><body>');
    win.document.write(content);
    win.document.write('</body></html>');
    win.document.close();
    win.print();
};
window.renderCardPreview = () => {
    const container = Utils.getEl('card-preview-area');
    container.innerHTML = STATE.cache.students.map(s => `<div class="card p-4 border mb-2 font-bold">${Utils.escapeHTML(s.nama)} - ${Utils.escapeHTML(s.id_peserta)}</div>`).join('');
};
window.updateCardLogo = () => {};
window.updateCardSignature = () => {};
// --- TAMBAHAN GLOBAL FUNCTIONS ---

// Fungsi untuk membuka/tutup dropdown tombol Terseleksi
window.toggleBulkActions = (e) => {
    e.stopPropagation(); // Mencegah event bubbling
    const dropdown = document.getElementById('dropdown-bulk-actions');
    
    // Hanya buka jika ada item yang dipilih
    if (View.selectedItems.length === 0) {
        alert("Pilih data peserta terlebih dahulu!");
        return;
    }

    if (dropdown) {
        dropdown.classList.toggle('hidden');
        dropdown.classList.toggle('block'); // Pastikan CSS block aktif
    }
};

// Tutup dropdown jika klik di luar (sudah ada di kode lama, tapi pastikan ini)
window.onclick = (e) => {
    if (!e.target.closest('#dropdown-bulk-actions') && !e.target.closest('button[onclick="toggleBulkActions(event)"]')) {
        const dropdown = document.getElementById('dropdown-bulk-actions');
        if (dropdown) {
            dropdown.classList.add('hidden');
            dropdown.classList.remove('block');
        }
    }
    // ... fungsi closeDropdowns lain ...
};
// Start App
document.addEventListener("DOMContentLoaded", () => App.init());






















